{% extends 'asset/base.html' %}




{% block content %}

    <ol class="breadcrumb">
        <li><a href="#">資產管理</a></li>

    </ol>


    <div class="panel panel-default" style="padding: 20px">

        <div class="row">

            <div class="col-md-4">

                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#assetform_add_Modal">
                    新增資產
                </button>


            </div>


            <div class="col-md-8" style="text-align: right">
                <form class="form-inline" method="get">

                    <div class="form-group">
                        <label for="inputsearch" class="col-form-label">搜尋</label>
                        <input type="" class="" id="search" placeholder="">
                    </div>

                    <div class="form-group">
                        <label class="col-form-label">類型</label>
                        <select class="form-control">
                            <option>-------</option>
                            {% for category in category_obj %}
                                <option value="{{ category.id }}">{{ category.name }}({{ category.code }})</option>
                            {% endfor %}
                        </select>
                    </div>


                    <div class="form-group">
                        <label class="col-form-label">部門</label>
                        <select class="form-control">
                            <option>-------</option>
                            {% for department in department_obj %}
                                <option value="{{ department.id }}">{{ department.name }}部({{ department.code }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn btn-success" style="margin-left: 20px">Submit</button>
                    </div>

                </form>
            </div>
        </div>


        <table class="table" id="mytable">
            <thead>
            <tr>
                <th>資產編號</th>
                <th>類型</th>
                <th>部門</th>
                <th>負責人</th>
                <th>購買日期</th>
                <th>價格</th>
                <th>操作</th>


            </tr>
            </thead>
            <tbody>
            {% for asset in asset_obj %}

                <tr>
                    <td name="sn"><span class="form-control-static">{{ asset.category.code }}-{{ asset.sn }}</span></td>
                    <td name="category">

                        <span class="form-control-static">
                            {{ asset.category }}
                        </span>
                        <select class="form-control" style="display: none">

                            {% for category in category_obj %}
                                {% if  asset.category  ==  category %}
                                    <option selected
                                            value="{{ category.id }}">{{ category.name }}({{ category.code }})
                                    </option>
                                {% else %}
                                    <option value="{{ category.id }}">{{ category.name }}({{ category.code }})</option>
                                {% endif %}

                            {% endfor %}
                        </select>


                    </td>

                    <td name="department">
                        <span class="form-control-static">
                            {{ asset.department }}
                        </span>

                        <select class="form-control" >

                            {% for department in department_obj %}
                                {% if  asset.department  ==  department %}
                                    <option selected
                                            value="{{ department.id }}">{{ department.name }}部({{ department.code }})
                                    </option>
                                {% else %}
                                    <option value="{{ department.id }}">{{ department.name }}部({{ department.code }})</option>
                                {% endif %}

                            {% endfor %}
                        </select>
                    </td>
                    <td name="manager">
                        <span class="form-control-static">
                            {{ asset.manager }}
                        </span>

                        <select class="form-control" >
                            <option value="">------</option>
                            {% for user in user_obj %}
                                {% if  asset.manager  ==  user %}
                                    <option selected
                                            value="{{ user.id }}">{{ user.name }}({{ user.code }})
                                    </option>
                                {% else %}
                                    <option value="{{ user.id }}">{{ user.name }}({{ user.code }})</option>
                                {% endif %}

                            {% endfor %}
                        </select>


                    </td>
                    <td><span class="form-control-static">{{ asset.create_date|date:"Y-m-d" }}</span></td>
                    <td name="price"><span class="form-control-static">{{ asset.price }}</span></td>
                    <td>
                        <i class="fas fa-pen"></i>
                        <i class="fas fa-trash-alt"></i>
                    </td>
                </tr>
            {% endfor %}


            </tbody>
        </table>

    </div>

    <div class="modal fade" id="assetform_add_Modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>

                    <h4 class="modal-title" id="myModalLabel">新增資產</h4>
                </div>
                <div class="modal-body">
                    <form method="post" id="assetform_add">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="">類型</label>
                            <select name="category" onchange="get_category(this)" class="form-control">
                                <option value="">-------</option>
                                {% for category in category_obj %}
                                    <option
                                            value="{{ category.id }}">{{ category.name }}({{ category.code }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="">資產編號</label>
                            <input type="text" name="sn" class="form-control" placeholder="">
                        </div>

                        <div class="form-group">
                            <label class="col-form-label">部門</label>
                            <select name="department" onchange="get_dent_user(this)" class="form-control">
                                <option value="">-------</option>
                                {% for department in department_obj %}
                                    <option name="department"
                                            value="{{ department.id }}">{{ department.name }}部({{ department.code }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="col-form-label">資產負責人</label>
                            <select id='user_select' name="manager" class="form-control">
                                <option value="">-------</option>
                                {#                                {% for user in user_obj %}#}
                                {#                                    <option value="{{ user.id }}">{{ user.name }}({{ user.dent.block_number }}{{ user.code }})</option>#}
                                {#                                {% endfor %}#}
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="col-form-label">價格</label>
                            <input name="price" type="number" class="form-control">
                        </div>

                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="assetform_submit" type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>




{% endblock %}


{% block extra-js %}

    <script>

        $(document).ready(function () {
            $('.dropdown-toggle').dropdown()
        });

        $('#myModal').on('hidden.bs.modal', function (e) {
            // do something...
        });


        $('#assetform_add_Modal').on('show.bs.modal', function (e) {
            $("#assetform_add").trigger('reset');
        });


        // 選擇類型後請求該分類數量
        function get_category(e) {
            //console.log(e);
            //console.log($(this));
            //console.log(e.value);

            $.ajax({
                url: "/api/category",
                type: "GET",
                data: {'cate': e.value},

                success: function (callback) {
                    //console.log(callback);
                    $('#assetform_add_Modal').find("[name='sn']").val(callback.number)
                },
                error: function () {
                }
            });
        };

        // 選擇類型後請求該分類數量
        function get_dent_user(e) {
            //console.log(e);
            //console.log($(this));
            //console.log(e.value);

            $.ajax({
                url: "/api/dent_user",
                type: "GET",
                data: {'dent': e.value},

                success: function (callback) {
                    console.log(callback);
                    document.getElementById("user_select").options.length = 1;
                    users = callback.users;
                    owner = callback.owner;
                    $.each(users, function (i, item) {
                            //console.log(item);

                            if (item.code == owner.code) {
                                //console.log(item.code);
                                //console.log(owner.code);

                                $('#user_select').append($('<option>', {
                                    value: item.id,
                                    text: item.user + "(" + item.code + ")",
                                    selected: true,
                                }));
                            } else {

                                $('#user_select').append($('<option>', {
                                    value: item.id,
                                    text: item.user + "(" + item.code + ")"
                                }));
                            }
                        }
                    );


                },
                error: function () {

                }
            });
        };


        // 提交 新增資產表單
        $("#assetform_add").on("submit", function (e) {
            //console.log(e);
            //console.log($(this));
            var postData = $(this).serializeArray();
            console.log(postData);

            $.ajax({
                url: "",
                type: "POST",
                data: postData,
                success: function (callback) {
                    console.log(callback);

                    if (callback.status == 'ok') {
                        $('#assetform_add_Modal').modal('hide');
                    } else {

                    }


                },
                error: function () {

                }
            });
            e.preventDefault();
        });

        $("#assetform_submit").on('click', function () {

            $("#assetform_add").submit();

        });

        //EditData : Change icon
        $("#mytable").on('click', "svg.svg-inline--fa.fa-pen.fa-w-16", function (ele) {
            console.log('edit');
            $(this).attr('data-icon', 'file');
            tds = $(this).parent().prevAll();
            tr = $(this).closest("tr");
            var obj_id = tr.find("[name='id']").text();
            //console.log(obj_id);
            $.each(tds, function (i, ele) {
                var txt = $(this).text();
                if ($(this).attr("name") == 'category') {
                    //console.log("EditData : Change icon");

                } else if ($(this).attr("name") == 'department') {

                } else if ($(this).attr("name") == 'manager') {

                }

                else {
                    $(this).html("").append("<input type='text' class='form-control match-content' value=\"" + txt + "\">");
                }
            })
        });


        //DeleteData : Delete icon
        $("#mytable").on('click', "svg.svg-inline--fa.fa-trash-alt.fa-w-14", function (ele) {
            console.log('Delete');


        });


    </script>

{% endblock %}


