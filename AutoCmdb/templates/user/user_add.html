{% extends 'user/base.html' %}
{% load asset_tags %}



{% block head %}
    <!-- CSS -->
    <link href="/static/css/bootstrap-datepicker.css" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/bootstrap-select.css">



    <!--  JavaScript -->
    <script src="/static/js/bootstrap-datepicker.js"></script>
    <script src="/static/js/bootstrap-datepicker.zh-TW.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/static/js/bootstrap-select.js"></script>

    <style>
        .col-md-2.col-form-label, .col-md-6.form-group, .col-md-10.form-control-static {
            padding-left: 15px;
        }

        .form-control-static {
            border: 1px solid #ccc;
            border-radius: 4px;
        }


    </style>



{% endblock %}



{% block content %}


    <ol class="breadcrumb">
        <li><a href="{% url 'user' %}">用戶管理</a></li>
        <li class="active">新增用戶</li>

    </ol>


    <div class="panel panel-default" style="padding: 20px">
        <form role="form" method="post" id="userform_add">
            {% csrf_token %}


            <!-- 錯誤提示-->
            <div class="alert" style="display: none">
                <strong></strong>
            </div>


            <div class="form-group">
                <label> 基本信息</label>
            </div>


            <div class="col-md-6 form-group has-feedback">
                <label for="">編號</label>
                <input type="number" name="code" class="form-control" placeholder=""
                       value="{{ forms_obj.dent.block_number }}{{ userinfo_obj.code }}">
                <span class="glyphicon form-control-feedback" style="margin-right: 15px;"></span>
            </div>


            <div class="col-md-6 form-group has-feedback">
                <label class="col-form-label">用戶名</label>
                {{ forms_obj.username }}
                <span class="glyphicon form-control-feedback" style="margin-right: 15px;"></span>
            </div>

            <div class="col-md-6 form-group has-feedback">
                <label class="col-form-label">姓名</label>
                {{ forms_obj.name }}
                <span class="glyphicon form-control-feedback" style="margin-right: 15px;"></span>
            </div>

            <div class="col-md-6 form-group has-feedback">
                <label class="col-form-label">性別</label>
                {{ forms_obj.sex }}
                <span class="glyphicon form-control-feedback" style="margin-right: 15px;"></span>
            </div>


            <div class="col-md-6 form-group has-feedback">
                <label class="col-form-label">部門</label>
                {{ forms_obj.dent }}
                <span class="glyphicon form-control-feedback" style="margin-right: 15px;"></span>
            </div>

            <div class="col-md-6 form-group has-feedback">
                <label class="col-form-label">生日</label>
                {{ forms_obj.birthday }}
                <span class="glyphicon form-control-feedback" style="margin-right: 15px;"></span>
            </div>

            <div class="col-md-12 form-group has-feedback" style="padding-left:15px; padding-right: 15px; ">
                <label> 在職狀態</label>
                {{ forms_obj.in_service }}
                <span class="glyphicon form-control-feedback" style="margin-right: 15px;"></span>
            </div>


            <div class="form-group">
                <label> 登入功能</label>


                <button id="change_passwd" type="button" class="btn btn-success"
                        style="margin-left: 20px;display: none">設定密碼
                </button>

            </div>


            <div class="form-inline ">
                <label class="col-md-2  col-form-label">狀態</label>
                {{ forms_obj.is_staff }}

            </div>


            <div class="form-inline" style="padding-right: 15px; display: none">
                <label class="col-md-2  col-form-label">密碼</label>

                {{ forms_obj.password1 }}
            </div>


            <div class="form-inline" style="padding-right: 15px; ; display: none">
                <label class="col-md-2  col-form-label">確認密碼</label>
                {{ forms_obj.password2 }}
            </div>

            <button id="userform_submit" type="button" class="btn btn-primary center-block">新增</button>


        </form>


    </div>




    <!--- 新增完成 表單-->
    <div class="modal fade" id="Modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">新增成功</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    是否還需要繼續新增資料
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <a href="{% url 'user' %}" class="btn btn-primary"  role="button">返回列表</a>
                    <a href="{% url 'user_add' %}" class="btn btn-success"  role="button">繼續新增</a>
                </div>

            </div>
        </div>
    </div>





{% endblock %}





{% block extra-js %}

    <script>
        function BeforeFormSubmit(e) {
            $(":disabled").removeAttr("disabled");
        }


        $("input[name='birthday']").datepicker(
            {
                language: 'zh-TW',
                format: "yyyy-mm-dd",
                todayHighlight: true,

            });


        // 選擇部門後請求該用戶編號
        function get_user_number(e) {
            console.log(e.value);

            $.ajax({
                url: "/api/add_user_number",
                type: "GET",
                data: {'id': e.value},

                success: function (callback) {
                    //console.log(callback);

                    if (callback.status == 'ok') {
                        $("#userform_add [name='code']").val(callback.data);
                        $("#userform_add [name='code']").removeAttr("disabled");
                    }
                    else {
                        console.log("請求錯誤");
                        $("#userform_add [name='code']").val("");
                        $("#userform_add [name='code']").attr("disabled", "disabled");
                    }


                },
                error: function () {
                    console.log("請求錯誤");
                    $("#userform_add [name='code']").val("");
                    $("#userform_add [name='code']").attr("disabled", "disabled");
                }
            });
        };


        // bind button
        $("#userform_submit").on("click", function (e) {
            $("#userform_add").submit();
        });


        // 提交 新增資產表單
        $("#userform_add").on("submit", function (e) {

            var postData = $(this).serializeArray();
            console.log(postData);

            $.ajax({
                url: "{% url 'user_add' %}",
                type: "POST",
                data: postData,
                success: function (callback) {
                    console.log(callback);

                    if (callback.status == 'ok') {
                        $(".alert").show();
                        $(".alert strong").text(callback.msg);
                        $(".alert").addClass("alert-success").removeClass("alert-danger");
                        $.each(callback.success_fields, function (i, val) {

                            input_tag = $("#userform_add [name='" + val + "']");
                            div_tag = input_tag.closest("div");
                            div_tag.removeClass("has-error").addClass("has-success");
                            div_tag.find("span").removeClass("glyphicon-remove").addClass("glyphicon-ok");

                        });

                        $("#Modal").modal('show')


                    } else {
                        $(".alert").show();
                        $(".alert").addClass("alert-danger");
                        $(".alert strong").text(callback.msg);

                        $("#userform_add .alert-danger strong").text(callback.msg);

                        console.log(callback.errors_fields);
                        console.log(callback.success_fields);

                        $.each(callback.errors_fields, function (i, val) {

                            input_tag = $("#userform_add [name='" + val + "']");
                            div_tag = input_tag.closest("div");
                            div_tag.removeClass("has-success").addClass("has-error");
                            div_tag.find("span").removeClass("glyphicon-ok").addClass("glyphicon-remove");


                        });

                        $.each(callback.success_fields, function (i, val) {

                            input_tag = $("#userform_add [name='" + val + "']");
                            div_tag = input_tag.closest("div");
                            div_tag.removeClass("has-error").addClass("has-success");
                            div_tag.find("span").removeClass("glyphicon-remove").addClass("glyphicon-ok");

                        });

                    }

                },
                error: function () {
                    $(".alert").show();
                    $(".alert").addClass("alert-danger");
                    $(".alert strong").text("輸入錯誤");


                }
            });
            e.preventDefault();
        });


        function ch_passwd_ele(e) {

            console.log(e.value);

            if (e.value == "True") {
                $("[name='password1']").closest(".form-inline").show();
                $("[name='password2']").closest(".form-inline").show();
            } else {
                $("[name='password1']").closest(".form-inline").hide();
                $("[name='password2']").closest(".form-inline").hide();
            }

        }


    </script>

{% endblock %}







